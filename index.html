<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Трекер привычек</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
    .habit-item { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; padding: 16px; border-bottom: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; background-color: #f9fafb; }
    .habit-header { display: flex; justify-content: space-between; width: 100%; align-items: center; }
    .habit-name { font-weight: 600; font-size: 16px; }
    .habit-streak { font-size: 14px; color: #6b7280; }
    .habit-days { font-size: 12px; color: #9ca3af; margin-top: 4px; }
    .completed .habit-name { color: #10b981; text-decoration: line-through; }
    .days-checkboxes { display: flex; justify-content: space-around; flex-wrap: wrap; margin-top: 8px; }
    .day-label { display: flex; align-items: center; font-size: 14px; margin-right: 8px; }
    input[type="checkbox"] { accent-color: #3b82f6; }
  </style>
</head>
<body class="bg-gray-50 p-4 antialiased">
  <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
    <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Трекер привычек</h1>
    
    <div class="mb-6">
      <input id="habitInput" type="text" placeholder="Название привычки" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
      
      <div class="days-checkboxes">
        <label class="day-label"><input type="checkbox" value="1" class="mr-1">Пн</label>
        <label class="day-label"><input type="checkbox" value="2" class="mr-1">Вт</label>
        <label class="day-label"><input type="checkbox" value="3" class="mr-1">Ср</label>
        <label class="day-label"><input type="checkbox" value="4" class="mr-1">Чт</label>
        <label class="day-label"><input type="checkbox" value="5" class="mr-1">Пт</label>
        <label class="day-label"><input type="checkbox" value="6" class="mr-1">Сб</label>
        <label class="day-label"><input type="checkbox" value="0" class="mr-1">Вс</label>
      </div>
      
      <button onclick="addHabit()" class="w-full mt-4 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-200">Добавить привычку</button>
    </div>
    
    <ul id="habitList" class="space-y-4"></ul>
    
    <button onclick="Telegram.WebApp.close()" class="w-full mt-6 bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition duration-200">Закрыть приложение</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let habits = JSON.parse(localStorage.getItem('habits')) || [];

    function getDayName(day) {
      const days = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
      return days[day];
    }

    function isActiveDay(habit, date) {
      const day = date.getDay();
      return habit.days.includes(day);
    }

    function renderHabits() {
      const habitList = document.getElementById('habitList');
      habitList.innerHTML = '';
      habits.forEach((habit, index) => {
        const li = document.createElement('li');
        li.className = `habit-item ${habit.completed ? 'completed' : ''}`;
        li.innerHTML = `
          <div class="habit-header">
            <span class="habit-name">${habit.name}</span>
            <span class="habit-streak">Стрик: ${habit.streak}</span>
          </div>
          <span class="habit-days">Дни: ${habit.days.map(getDayName).join(', ')}</span>
          <div class="mt-4 w-full flex space-x-2">
            <button onclick="toggleHabit(${index})" class="flex-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-200 ${!isActiveDay(habit, new Date()) ? 'opacity-50 cursor-not-allowed' : ''}">${habit.completed ? 'Отменить' : 'Выполнить'}</button>
            <button onclick="deleteHabit(${index})" class="flex-1 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-200">Удалить</button>
          </div>
        `;
        habitList.appendChild(li);
      });
    }

    function addHabit() {
      const habitInput = document.getElementById('habitInput');
      const habitName = habitInput.value.trim();
      const checkboxes = document.querySelectorAll('.days-checkboxes input[type="checkbox"]:checked');
      const days = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      if (habitName && days.length > 0) {
        habits.push({ name: habitName, days: days.sort(), streak: 0, completed: false, lastCompleted: null });
        habitInput.value = '';
        checkboxes.forEach(cb => cb.checked = false);
        saveAndRender();
        tg.showAlert('Привычка добавлена!');
      } else {
        tg.showAlert('Введите название и выберите хотя бы один день!');
      }
    }

    function toggleHabit(index) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const habit = habits[index];
      
      if (!isActiveDay(habit, today)) {
        tg.showAlert('Сегодня не активный день для этой привычки!');
        return;
      }
      
      if (habit.completed && habit.lastCompleted === todayStr) {
        habit.completed = false;
        habit.streak = Math.max(0, habit.streak - 1);
      } else if (!habit.completed) {
        habit.completed = true;
        habit.lastCompleted = todayStr;
        habit.streak += 1;
      }
      saveAndRender();
    }

    function deleteHabit(index) {
      habits.splice(index, 1);
      saveAndRender();
    }

    function saveAndRender() {
      localStorage.setItem('habits', JSON.stringify(habits));
      renderHabits();
    }

    function checkDailyReset() {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().split('T')[0];
      
      habits.forEach(habit => {
        if (habit.lastCompleted !== todayStr) {
          habit.completed = false;
        }
        // Сброс стрика, если вчера был активный день и не выполнен
        if (isActiveDay(habit, yesterday) && habit.lastCompleted !== yesterdayStr) {
          habit.streak = 0;
        }
      });
      saveAndRender();
    }

    checkDailyReset();
    renderHabits();
  </script>
</body>
</html>
